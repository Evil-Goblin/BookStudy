## parallel stream
- 데이터 소스가 `Stream.iterate` 거나 중간 연산으로 `limit` 를 사용하면 파이프라인 병렬화로 성능 개선을 기대할 수 없다.
  - 파이프라인 병렬화는 `limit` 를 다룰 때 CPU 코어가 남는다면 원소를 몇 개 더 처리한 후 제한된 개수 이후의 결과를 버려도 아무런 해가 없다고 가정한다.
  - 때문에 원소 하나를 계산하는 비용이 큰 경우 성능 개선이 되지 않는다.
- 데이터 소스가 `ArrayList` , `HashMap` , `HashSet` , `ConcurrentHashMap` , 배열 , `int range` , `long range` 인 경우 병렬화의 효과가 가장 좋다.
  - 데이터를 원하는 크기로 나눠 다수의 스레드에 분배되기 좋기 때문
- 위 자료구조들의 참조 지역성이 뛰어난 것도 중요하다.
  - 이웃한 원소의 참조들이 메모리에 연속해서 저장되는 것을 뜻한다.
- 참조 지역성이 낮으면 스레드는 데이터가 주 메모리에서 캐시 메모리로 전송되어 오기를 기다리게 된다.
  - 참조 지역성은 다량의 데이터를 처리하는 벌크 연산을 병렬화할 때 중요한 요소로 작용한다.
- 참조 지역성이 가장 뛰어난 자료구조는 배열이다.
- 종단 연산에서 수행하는 작업 량은 파이프라인 전체 작업 중 비중이 높다.
- 종단 연산 중 병렬화에 가장 적합한 것은 축소 이다.
  - 축소는 파이프라인에서 만들어진 모든 원소를 하나로 합치는 작업으로, `reduce` 메서드 중 하나, 혹은 `min` , `max` , `count` , `sum` 같이 완성된 형태로 제공되는 메서드 중 하나를 선택해 수행한다.
- `anyMatch` , `allMatch` , `noneMatch` 와 같이 조건에 맞으면 바로 반환되는 메서드도 병렬화에 적합하다.
- 반면 `collect` 와 같은 가변 축소는 병렬화에 적합하지 않다.
  - 컬렉션을 함치는 부담이 크다.
- **스트림을 잘못 병렬화하면 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다.**
- 만약 데이터 소스 스트림이 효율적으로 나눠지고, 병렬화하거나 빨리 끝나는 종단 연산을 사용하고, 함수 객체들도 간섭하지 않더라도, 파이프라인이 수행하는 진짜 작업이 병렬화에 드는 추가 비용을 상쇄하지 못한다면 성능 향상은 미미할 수 있다.
- 스트림 병렬화는 오직 성능 최적화 수단이다.
  - 다른 최적화와 마찬가지로 적용 전후 성능 테스트를 통해 적합성을 확인해야 한다.
- **조건만 맞는다면 parallel 을 통해 프로세서 코어 수에 비례하는 성능 향상을 맛볼 수 있다.**
- 만약 무작위 수들로 이뤄진 스트림을 병렬화하는 경우 `ThreadLocalRandom`(또는 `Random`) 보다 `SplittableRandom` 인스턴스를 이용하는 것이 좋다.
  - `SplittableRandom` 은 이런 경우 사용하기 위해 설계되었기 때문에 병렬화시 성능이 선형으로 증가한다.
  - 반면 `ThreadLocalRandom` 은 단일 스레드에서 사용하고자 만들어졌기 때문에 상대적으로 느리다.
  - `Random` 은 모든 연산을 동기화하기 때문에 병렬처리시 최악의 성능을 보인다.

## 안젼 실패(safety failure)
- 결과가 잘못되거나 오작동하는 것
- 안전 실패는 병렬화한 파이프라인이 사용하는 `mappers` , `filters` , 혹은 다른 함수 객체가 명세대로 동작하지 않을 때 벌어질 수 있다.
- `Stream` 명세는 이때 사용되는 함수 객체에 관한 엄중한 규약을 정의해놓았다.
  - `Stream` 의 `reduce` 연산에 건내지는 `accumulator` 와 `combiner` 함수는 반드시 결합법칙을 만족하고, 간섭받지 않고, 상태를 갖지 않아야 한다.
  - 이 요구사항이 지켜지지 않을 경우 순차일때는 문제가 없더라도 병렬로 수행했을때 문제가 발생할 수 있다.

## 병렬화 성능 추정
- 스트림 안의 원소 수와 원소당 수행되는 코드 줄 수를 곱한다.
- 곱한 값이 최소 수십만은 되어야 성능 향상을 맛볼 수 있다.

## 정리
- 계산도 올바로 수행하고 성능도 빨라질 거라는 확신 없이는 병렬화를 시도하지 말자.
- 잘못된 병렬화는 오작동이나 성능을 크게 떨어뜨린다.
- 적용시에는 코드가 정확한지 확인 후 적용 전후의 성능 검사가 필수이다.
- 계산도 정확하고 성능도 좋아짐이 확실한 경우에만 병렬화를 적용하라.
